<!DOCTYPE html>
<html lang="zh-TW">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>平板專用倒數計時器</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* 引入多款科技感數字字型 */
        @import url('https://fonts.googleapis.com/css2?family=Chakra+Petch:wght@500;700&family=Orbitron:wght@600;900&family=Bebas+Neue&family=Michroma&family=JetBrains+Mono:wght@800&display=swap');

        body {
            font-family: 'Chakra Petch', sans-serif;
            background-color: #050505;
            color: #e0e0e0;
            overflow: hidden;
            touch-action: manipulation;
        }

        /* 字體類別定義 */
        .font-orbitron {
            font-family: 'Orbitron', sans-serif;
            font-weight: 900;
            letter-spacing: -0.02em;
        }

        .font-bebas {
            font-family: 'Bebas Neue', sans-serif;
            font-weight: 400;
            letter-spacing: 0.05em;
            font-size: 1.2em;
            /* 加大 */
        }

        .font-michroma {
            font-family: 'Michroma', sans-serif;
            font-weight: 400;
            letter-spacing: -0.05em;
            font-size: 0.85em;
            /* 縮小防止超出 */
        }

        .font-jetbrains {
            font-family: 'JetBrains Mono', monospace;
            font-weight: 800;
            letter-spacing: -0.05em;
        }

        .rounded-nums {
            /* 預設繼承或由 JS 切換 */
            transition: font-family 0.3s ease;
        }

        /* 霓虹文字效果 - 柔和版 */
        .neon-text {
            text-shadow: 0 0 10px rgba(0, 255, 255, 0.4),
                0 0 20px rgba(0, 255, 255, 0.2);
            color: #ffffff;
        }

        /* 銀色金屬質感 (Metallic Silver / Chrome) */
        .metallic-text {
            background: linear-gradient(180deg,
                    #f8f9fa 0%,
                    #ffffff 20%,
                    #d1d5db 45%,
                    #9ca3af 50%,
                    #d1d5db 55%,
                    #f3f4f6 80%,
                    #cbd5e1 100%);
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
            /* 強制邊界光與立體感 */
            filter: drop-shadow(0 4px 6px rgba(0, 0, 0, 0.7)) drop-shadow(0 0 1px rgba(255, 255, 255, 0.8));
        }

        .neon-text-finished {
            text-shadow: 0 0 15px rgba(255, 80, 80, 0.9),
                0 0 30px rgba(255, 80, 80, 0.6);
            color: #ffcccc;
            background: none;
            -webkit-background-clip: unset;
            background-clip: unset;
            -webkit-text-fill-color: initial;
            filter: none;
        }

        /* 按鈕樣式 */
        .btn-glass {
            background: rgba(255, 255, 255, 0.08);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.15);
            transition: all 0.2s cubic-bezier(0.25, 0.46, 0.45, 0.94);
        }

        .btn-glass:active {
            background: rgba(255, 255, 255, 0.2);
            transform: scale(0.92);
        }

        /* 控制列過渡動畫 */
        .controls-panel {
            transition: transform 0.4s cubic-bezier(0.2, 0.8, 0.2, 1), opacity 0.3s ease;
        }

        .controls-hidden {
            transform: translateY(120%);
            opacity: 0;
            pointer-events: none;
        }

        .hidden-force {
            display: none !important;
        }

        /* 移除預設的 input number 上下箭頭 */
        input[type=number]::-webkit-inner-spin-button,
        input[type=number]::-webkit-outer-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }

        /* 全螢幕霓虹外框 */
        #neon-border {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            pointer-events: none;
            z-index: 100;
            border: 12px solid transparent;
            transition: all 1s ease;
            opacity: 0;
            box-sizing: border-box;
        }

        @keyframes border-breathe {

            0%,
            100% {
                border-width: 6px;
                filter: brightness(1);
            }

            50% {
                border-width: 14px;
                filter: brightness(1.5);
            }
        }

        /* 幻彩循環動畫 */
        @keyframes border-color-cycle {
            0% {
                border-color: #00ffff;
                box-shadow: inset 0 0 30px #00ffff, 0 0 30px #00ffff;
            }

            25% {
                border-color: #ff00ff;
                box-shadow: inset 0 0 30px #ff00ff, 0 0 30px #ff00ff;
            }

            50% {
                border-color: #ffff00;
                box-shadow: inset 0 0 30px #ffff00, 0 0 30px #ffff00;
            }

            75% {
                border-color: #00ff00;
                box-shadow: inset 0 0 30px #00ff00, 0 0 30px #00ff00;
            }

            100% {
                border-color: #00ffff;
                box-shadow: inset 0 0 30px #00ffff, 0 0 30px #00ffff;
            }
        }

        .border-running {
            opacity: 1 !important;
            animation: border-breathe 3s ease-in-out infinite, border-color-cycle 8s linear infinite;
        }

        /* 讓計時數字最大化且置中 */
        #time-display {
            font-size: min(25vw, 65vh);
            /* 縮小以防止溢出 */
            font-variant-numeric: tabular-nums;
            /* 強制等寬數字，防止寬度跳動 */
            font-feature-settings: "tnum";
            transition: all 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            display: flex;
            justify-content: center;
            align-items: center;
            width: 100%;
            white-space: nowrap;
        }

        /* 直向模式優化：分在上、秒在下 */
        @media (orientation: portrait) {
            #time-display {
                flex-direction: column;
                gap: 5vh;
                /* 增加垂直間距 */
                font-size: min(45vw, 35vh);
                /* 在直式下字體可以更大 */
                line-height: 0.9;
            }

            #time-sep {
                display: none;
                /* 隱藏冒號，靠上下位置區分 */
            }
        }

        /* 計時中的縮放效果 - 稍微縮小 scale 避免溢出 */
        .display-running {
            transform: scale(1.05);
        }

        /* 時鐘模式：稍微縮小字體以容納 HH:MM:SS */
        .clock-mode-text {
            font-size: min(18vw, 50vh) !important;
        }

        /* 直式時鐘模式優化 */
        @media (orientation: portrait) {
            .clock-mode-text {
                font-size: min(35vw, 30vh) !important;
                gap: 2vh !important;
                /* 時鐘模式直式間距稍縮 */
            }
        }

        /* 手機版面適配 */
        @media (max-width: 768px) {
            #controls-panel {
                height: 40vh;
                /* Fixed syntax error */
                padding-bottom: 2rem;
            }

            .btn-glass {
                padding: 0.5rem 0.75rem;
                font-size: 0.8rem;
            }

            .text-xl {
                font-size: 1rem;
            }

            .w-28 {
                width: 5rem;
                height: 5rem;
            }

            .h-28 {
                width: 5rem;
                height: 5rem;
            }

            /* 調整音效/字型選擇區塊 */
            #sound-selector button,
            #font-selector button {
                padding: 0.25rem 0.5rem;
                font-size: 0.65rem;
            }

            .ml-6 {
                margin-left: 1rem;
            }

            .gap-10 {
                gap: 1.5rem;
            }
        }
    </style>
</head>

<body class="h-screen w-screen flex flex-col items-center justify-center relative select-none bg-[#0a0a0a]">

    <!-- 全螢幕霓虹外框 -->
    <div id="neon-border"></div>

    <!-- 主顯示區域 (極大化) -->
    <div id="main-container"
        class="relative w-full h-[80vh] flex flex-col items-center justify-center transition-all duration-500 z-10">

        <!-- 時間顯示 -->
        <!-- 修改：加入 metallic-text -->
        <div id="time-display"
            class="rounded-nums neon-text metallic-text tracking-tight cursor-pointer active:scale-95 transition-transform duration-200 select-none">
            <span id="time-hour" class="hidden-force">12</span>
            <span id="time-sep-hour" class="hidden-force">:</span>
            <span id="time-min">05</span>
            <span id="time-sep">:</span>
            <span id="time-sec">00</span>
        </div>

        <!-- 狀態文字 -->
        <div id="status-text"
            class="text-5xl mt-4 font-bold tracking-[0.2em] opacity-0 transition-opacity duration-300 text-red-500 rounded-nums">
            TIME'S UP
        </div>


    </div>

    <!-- 底部控制面板 -->
    <div id="controls-panel"
        class="controls-panel fixed bottom-0 w-full h-[35vh] bg-gradient-to-t from-black via-black/95 to-transparent flex flex-col items-center justify-end pb-10 z-20">

        <!-- 快速加減/輸入區 -->
        <div id="setup-controls" class="flex items-center gap-4 mb-6">
            <button id="btn-minus"
                class="btn-glass w-16 h-16 rounded-full text-4xl text-cyan-300 flex items-center justify-center pb-2 font-bold">-</button>
            <div class="flex gap-3">
                <button class="quick-add btn-glass px-5 py-3 rounded-2xl text-lg font-bold tracking-wide"
                    data-add="30">+30秒</button>
                <button class="quick-add btn-glass px-5 py-3 rounded-2xl text-lg font-bold tracking-wide"
                    data-add="60">+1分</button>
                <button class="quick-add btn-glass px-5 py-3 rounded-2xl text-lg font-bold tracking-wide"
                    data-add="300">+5分</button>
            </div>
            <button id="btn-plus"
                class="btn-glass w-16 h-16 rounded-full text-4xl text-cyan-300 flex items-center justify-center pb-2 font-bold">+</button>
        </div>

        <!-- 主要操作按鈕區 -->
        <div class="flex items-center gap-10">

            <!-- 重置 -->
            <button id="btn-reset"
                class="btn-glass px-8 py-4 rounded-full text-red-300 border-red-900/40 hover:bg-red-900/20 flex items-center gap-3 transition-all active:scale-95 group">
                <svg class="group-hover:-rotate-90 transition-transform duration-300" xmlns="http://www.w3.org/2000/svg"
                    width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"
                    stroke-linecap="round" stroke-linejoin="round">
                    <path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74-2.74L3 12" />
                </svg>
                <span class="text-xl font-bold">重置</span>
            </button>

            <!-- 開始/暫停 (主按鈕加大) -->
            <button id="btn-main-action"
                class="w-28 h-28 rounded-full bg-cyan-500 shadow-[0_0_30px_rgba(6,182,212,0.6)] hover:bg-cyan-400 active:scale-90 transition-all flex items-center justify-center text-white ring-4 ring-cyan-900/50">
                <svg id="icon-play" class="w-14 h-14 ml-2" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M8 5v14l11-7z" />
                </svg>
                <svg id="icon-pause" class="w-14 h-14 hidden-force" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z" />
                </svg>
            </button>

            <!-- 音效與字型選擇區 -->
            <div class="flex flex-col gap-4 ml-6">
                <!-- 音效選擇 -->
                <div id="sound-selector" class="flex flex-col items-start gap-2">
                    <span class="text-[10px] text-cyan-400 font-bold tracking-widest uppercase opacity-60">Alarm
                        Sound</span>
                    <div class="flex gap-2">
                        <button id="btn-sound-default"
                            class="btn-glass px-3 py-1.5 rounded-lg text-[10px] font-bold">和弦</button>
                        <button id="btn-sound-thinking"
                            class="btn-glass px-3 py-1.5 rounded-lg text-[10px] font-bold">思考</button>
                        <button id="btn-sound-entertainment"
                            class="btn-glass px-3 py-1.5 rounded-lg text-[10px] font-bold">綜藝</button>
                        <button id="btn-sound-custom"
                            class="btn-glass px-3 py-1.5 rounded-lg text-[10px] font-bold opacity-50">自訂</button>
                    </div>
                </div>
                <!-- 字型選擇 -->
                <div id="font-selector" class="flex flex-col items-start gap-2">
                    <span class="text-[10px] text-purple-400 font-bold tracking-widest uppercase opacity-60">Display
                        Font</span>
                    <div class="flex gap-2">
                        <button class="font-switch btn-glass px-3 py-1.5 rounded-lg text-[10px] font-bold"
                            data-font="orbitron">Orbitron</button>
                        <button class="font-switch btn-glass px-3 py-1.5 rounded-lg text-[10px] font-bold"
                            data-font="bebas">Bebas</button>
                        <button class="font-switch btn-glass px-3 py-1.5 rounded-lg text-[10px] font-bold"
                            data-font="michroma">Michroma</button>
                        <button class="font-switch btn-glass px-3 py-1.5 rounded-lg text-[10px] font-bold"
                            data-font="jetbrains">JetBrains</button>
                    </div>
                </div>
            </div>

            <!-- 模式切換 (右下角) -->
            <div class="absolute right-6 bottom-10 flex flex-col gap-2">
                <button id="btn-mode-toggle"
                    class="btn-glass px-4 py-2 rounded-xl text-xs font-bold text-cyan-300 border-cyan-800/50 flex items-center gap-2">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="12" cy="12" r="10"></circle>
                        <polyline points="12 6 12 12 16 14"></polyline>
                    </svg>
                    切換時鐘
                </button>
            </div>

            <input type="file" id="audio-upload" accept="audio/*" class="hidden">
        </div>

        <!-- 時間到專用按鈕 -->
        <div id="finished-controls"
            class="hidden-force flex items-center gap-6 w-full justify-center absolute bottom-12 left-0">
            <button id="btn-back-settings"
                class="btn-glass px-8 py-4 rounded-2xl text-xl font-bold flex items-center gap-3 text-gray-300 border-gray-600">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3">
                    <path d="M19 12H5M12 19l-7-7 7-7" />
                </svg>
                返回
            </button>
            <button id="btn-restart"
                class="bg-red-600 hover:bg-red-500 text-white px-10 py-4 rounded-2xl text-xl font-bold shadow-[0_0_20px_rgba(220,38,38,0.6)] flex items-center gap-3">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3">
                    <path d="M23 4v6h-6" />
                    <path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10" />
                </svg>
                重來
            </button>
        </div>
    </div>

    <!-- 時間輸入 Modal (支援分:秒) -->
    <div id="input-modal"
        class="fixed inset-0 bg-black/90 z-50 hidden-force flex items-center justify-center backdrop-blur-md">
        <div
            class="bg-gray-900 border border-gray-700 p-8 rounded-[2rem] w-[500px] text-center shadow-2xl transform scale-100 transition-transform">
            <h3 class="text-2xl text-cyan-400 mb-8 font-bold tracking-wide">設定時間</h3>

            <div class="flex items-center justify-center gap-4 mb-8">
                <div class="flex flex-col">
                    <input type="number" id="input-min"
                        class="rounded-nums w-40 bg-gray-800 text-white text-7xl text-center p-4 rounded-2xl border-2 border-gray-600 focus:border-cyan-500 focus:outline-none focus:bg-gray-800 transition-colors placeholder-gray-600"
                        placeholder="00">
                    <span class="text-gray-500 text-sm mt-2 font-bold">分</span>
                </div>
                <span class="text-6xl text-gray-600 -mt-8">:</span>
                <div class="flex flex-col">
                    <input type="number" id="input-sec"
                        class="rounded-nums w-40 bg-gray-800 text-white text-7xl text-center p-4 rounded-2xl border-2 border-gray-600 focus:border-cyan-500 focus:outline-none focus:bg-gray-800 transition-colors placeholder-gray-600"
                        placeholder="00">
                    <span class="text-gray-500 text-sm mt-2 font-bold">秒</span>
                </div>
            </div>

            <div class="grid grid-cols-2 gap-6">
                <button id="btn-modal-cancel"
                    class="btn-glass py-4 rounded-2xl text-gray-400 text-xl font-bold hover:bg-white/5">取消</button>
                <button id="btn-modal-confirm"
                    class="bg-cyan-600 hover:bg-cyan-500 text-white py-4 rounded-2xl font-bold text-xl shadow-lg shadow-cyan-900/50">確定</button>
            </div>
        </div>
    </div>

    <script>
        const state = {
            totalSeconds: 300,
            remainingSeconds: 300,
            intervalId: null,
            status: 'IDLE',
            isControlsVisible: true,
            audioContext: null,
            audioMode: 'default', // 'default', 'thinking', 'entertainment', 'custom'
            fontMode: 'orbitron', // 'orbitron', 'bebas', 'michroma', 'jetbrains'
            displayMode: 'timer', // 'timer' | 'clock'
            clockIntervalId: null,
            wakeLock: null, // Wake Lock Sentinel
            customBuffer: null,
            presets: {
                thinking: { url: '思考音效.MP3', buffer: null },
                entertainment: { url: '時間綜藝.MP3', buffer: null }
            }
        };

        const dom = {
            container: document.getElementById('main-container'),
            display: document.getElementById('time-display'),
            timeHour: document.getElementById('time-hour'), // New
            timeSepHour: document.getElementById('time-sep-hour'), // New
            timeMin: document.getElementById('time-min'),
            timeSec: document.getElementById('time-sec'),
            statusText: document.getElementById('status-text'),
            controlsPanel: document.getElementById('controls-panel'),
            setupControls: document.getElementById('setup-controls'),
            mainActionBtn: document.getElementById('btn-main-action'),
            resetBtn: document.getElementById('btn-reset'),
            iconPlay: document.getElementById('icon-play'),
            iconPause: document.getElementById('icon-pause'),
            finishedControls: document.getElementById('finished-controls'),
            btnRestart: document.getElementById('btn-restart'),
            btnBack: document.getElementById('btn-back-settings'),
            btnModeToggle: document.getElementById('btn-mode-toggle'), // New
            // Inputs
            modal: document.getElementById('input-modal'),
            inputMin: document.getElementById('input-min'),
            inputSec: document.getElementById('input-sec'),
            neonBorder: document.getElementById('neon-border'),
            btnSoundDefault: document.getElementById('btn-sound-default'),
            btnSoundThinking: document.getElementById('btn-sound-thinking'),
            btnSoundEntertainment: document.getElementById('btn-sound-entertainment'),
            btnSoundCustom: document.getElementById('btn-sound-custom'),
            audioUpload: document.getElementById('audio-upload')
        };

        const audioEngine = {
            ctx: null,
            reverbNode: null,

            async init() {
                if (!this.ctx) {
                    this.ctx = new (window.AudioContext || window.webkitAudioContext)();
                    this.reverbNode = await this.createReverb();
                }
                if (this.ctx.state === 'suspended') {
                    this.ctx.resume();
                }
            },

            async createReverb() {
                const len = this.ctx.sampleRate * 1.5;
                const buffer = this.ctx.createBuffer(2, len, this.ctx.sampleRate);
                for (let channel = 0; channel < 2; channel++) {
                    const data = buffer.getChannelData(channel);
                    for (let i = 0; i < len; i++) {
                        data[i] = (Math.random() * 2 - 1) * Math.pow(1 - i / len, 2.5);
                    }
                }
                const convolver = this.ctx.createConvolver();
                convolver.buffer = buffer;
                convolver.connect(this.ctx.destination);
                return convolver;
            },

            playBeep() {
                this.init();
                const t = this.ctx.currentTime;
                const osc = this.ctx.createOscillator();
                const gain = this.ctx.createGain();

                osc.type = 'sine';
                osc.frequency.setValueAtTime(1200, t);
                osc.frequency.exponentialRampToValueAtTime(1000, t + 0.05);

                gain.gain.setValueAtTime(0, t);
                gain.gain.linearRampToValueAtTime(0.1, t + 0.005);
                gain.gain.exponentialRampToValueAtTime(0.001, t + 0.08);

                osc.connect(gain);
                gain.connect(this.reverbNode || this.ctx.destination);

                osc.start(t);
                osc.stop(t + 0.1);
            },

            async playAlarm() {
                this.init();

                // 處理自訂與預設 MP3
                let bufferToPlay = null;

                if (state.audioMode === 'custom' && state.customBuffer) {
                    bufferToPlay = state.customBuffer;
                } else if (state.audioMode === 'thinking' || state.audioMode === 'entertainment') {
                    const preset = state.presets[state.audioMode];
                    if (!preset.buffer) {
                        try {
                            const response = await fetch(preset.url);
                            const arrayBuffer = await response.arrayBuffer();
                            preset.buffer = await this.ctx.decodeAudioData(arrayBuffer);
                        } catch (e) {
                            console.error("Failed to load preset audio", e);
                        }
                    }
                    bufferToPlay = preset.buffer;
                }

                if (bufferToPlay) {
                    const source = this.ctx.createBufferSource();
                    source.buffer = bufferToPlay;
                    source.connect(this.reverbNode || this.ctx.destination);
                    source.start(0);
                    return;
                }

                // 否則播放預設和弦
                const t = this.ctx.currentTime;
                const freqs = [261.63, 329.63, 392.00, 523.25]; // C-E-G-C (C Major Chord)

                freqs.forEach((f, i) => {
                    const osc = this.ctx.createOscillator();
                    const gain = this.ctx.createGain();
                    const filter = this.ctx.createBiquadFilter();

                    osc.type = i % 2 === 0 ? 'triangle' : 'sine';
                    osc.frequency.setValueAtTime(f, t);

                    filter.type = 'lowpass';
                    filter.frequency.setValueAtTime(2000, t);
                    filter.frequency.exponentialRampToValueAtTime(500, t + 2);

                    gain.gain.setValueAtTime(0, t);
                    gain.gain.linearRampToValueAtTime(0.15, t + 0.2);
                    gain.gain.exponentialRampToValueAtTime(0.001, t + 2.5);

                    osc.connect(filter);
                    filter.connect(gain);
                    gain.connect(this.reverbNode || this.ctx.destination);

                    osc.start(t);
                    osc.stop(t + 3);
                });
            }
        };


        function updateDisplay() {
            const m = Math.floor(state.remainingSeconds / 60).toString().padStart(2, '0');
            const s = (state.remainingSeconds % 60).toString().padStart(2, '0');
            dom.timeMin.textContent = m;
            dom.timeSec.textContent = s;

            const pct = state.totalSeconds > 0 ? (state.remainingSeconds / state.totalSeconds) * 100 : 0;


            // 更新外框顏色與呼吸效果
            if (state.status === 'RUNNING') {
                dom.neonBorder.classList.add('border-running');
                dom.display.classList.add('display-running');

                // 外框現在使用 CSS 動畫自動循環顏色，這裡不再覆蓋


                dom.display.classList.remove('neon-text-finished');
                dom.display.style.color = '#ffffff';
                dom.statusText.style.opacity = '0';
            } else if (state.status === 'FINISHED') {
                dom.neonBorder.classList.add('border-running');
                dom.neonBorder.style.borderColor = '#ff5050';
                dom.neonBorder.style.boxShadow = `inset 0 0 50px #ff5050, 0 0 50px #ff5050`;

                dom.display.classList.add('neon-text-finished');
                dom.statusText.style.opacity = '1';
                dom.display.classList.remove('display-running');
            } else {
                dom.neonBorder.classList.remove('border-running');
                dom.neonBorder.style.borderColor = 'transparent';
                dom.neonBorder.style.boxShadow = 'none';
                dom.display.classList.remove('display-running');
                dom.display.classList.remove('neon-text-finished');
                dom.statusText.style.opacity = '0';
            }
        }

        function updateControlsUI() {
            if (state.status === 'RUNNING') {
                dom.iconPlay.classList.add('hidden-force');
                dom.iconPause.classList.remove('hidden-force');
                dom.setupControls.classList.add('hidden-force');
                dom.resetBtn.classList.remove('opacity-0', 'pointer-events-none');
            } else if (state.status === 'PAUSED') {
                dom.iconPlay.classList.remove('hidden-force');
                dom.iconPause.classList.add('hidden-force');
                dom.setupControls.classList.remove('hidden-force'); // 暫停時顯示加減鈕
            } else if (state.status === 'IDLE') {
                dom.iconPlay.classList.remove('hidden-force');
                dom.iconPause.classList.add('hidden-force');
                dom.setupControls.classList.remove('hidden-force');
            }

            // 更新音效選取按鈕
            [dom.btnSoundDefault, dom.btnSoundThinking, dom.btnSoundEntertainment, dom.btnSoundCustom].forEach(btn => {
                btn.classList.remove('ring-1', 'ring-cyan-500/50', 'bg-cyan-500/10');
                btn.classList.add('opacity-50');
            });

            const activeBtnMap = {
                'default': dom.btnSoundDefault,
                'thinking': dom.btnSoundThinking,
                'entertainment': dom.btnSoundEntertainment,
                'custom': dom.btnSoundCustom
            };

            const activeBtn = activeBtnMap[state.audioMode];
            if (activeBtn) {
                activeBtn.classList.add('ring-1', 'ring-cyan-500/50', 'bg-cyan-500/10');
                activeBtn.classList.remove('opacity-50');
            }

            // 更新字型選取按鈕
            document.querySelectorAll('.font-switch').forEach(btn => {
                const f = btn.dataset.font;
                if (f === state.fontMode) {
                    btn.classList.add('ring-1', 'ring-purple-500/50', 'bg-purple-500/10');
                    btn.classList.remove('opacity-50');
                } else {
                    btn.classList.remove('ring-1', 'ring-purple-500/50', 'bg-purple-500/10');
                    btn.classList.add('opacity-50');
                }
            });

            // 套用字型到顯示器
            dom.display.classList.remove('font-orbitron', 'font-bebas', 'font-michroma', 'font-jetbrains');
            dom.display.classList.add(`font-${state.fontMode}`);

            if (state.status === 'FINISHED') {
                dom.setupControls.classList.add('hidden-force');
                dom.mainActionBtn.parentElement.classList.add('hidden-force');
                dom.finishedControls.classList.remove('hidden-force');
            } else {
                dom.finishedControls.classList.add('hidden-force');
                dom.mainActionBtn.parentElement.classList.remove('hidden-force');
            }
        }

        // Wake Lock API Implementation
        async function requestWakeLock() {
            try {
                if ('wakeLock' in navigator) {
                    state.wakeLock = await navigator.wakeLock.request('screen');
                    console.log('Wake Lock active');
                }
            } catch (err) {
                console.error(`${err.name}, ${err.message}`);
            }
        }

        function releaseWakeLock() {
            if (state.wakeLock !== null) {
                state.wakeLock.release()
                    .then(() => {
                        state.wakeLock = null;
                        console.log('Wake Lock released');
                    });
            }
        }

        // Handle visibility change to re-acquire lock
        document.addEventListener('visibilitychange', async () => {
            if (state.wakeLock !== null && document.visibilityState === 'visible') {
                await requestWakeLock();
            }
        });

        function startTimer() {
            if (state.remainingSeconds <= 0) return;
            state.status = 'RUNNING';
            audioEngine.init();
            updateControlsUI();
            updateDisplay();
            hideControls(); // 開始後自動隱藏控制列
            requestWakeLock(); // Request Wake Lock

            state.intervalId = setInterval(() => {
                state.remainingSeconds--;
                updateDisplay();
                if (state.remainingSeconds <= 0) {
                    finishTimer();
                }
            }, 1000);
        }

        function pauseTimer() {
            clearInterval(state.intervalId);
            state.status = 'PAUSED';
            updateControlsUI();
            updateDisplay();
            showControls(); // 暫停時自動顯示控制列
            releaseWakeLock(); // Release Wake Lock on pause
        }

        function resetTimer() {
            clearInterval(state.intervalId);
            state.remainingSeconds = state.totalSeconds;
            state.status = 'IDLE';
            updateControlsUI();
            updateDisplay();
            showControls();
            releaseWakeLock(); // Release Wake Lock logic handled here implicitly as it's not runnign
        }

        function finishTimer() {
            clearInterval(state.intervalId);
            state.status = 'FINISHED';
            state.remainingSeconds = 0;
            updateDisplay();
            updateControlsUI();
            showControls();
            audioEngine.playAlarm();
            releaseWakeLock(); // Release Wake Lock when done
        }

        // Clock Mode Logic
        function updateClock() {
            const now = new Date();
            const h = now.getHours().toString().padStart(2, '0');
            const m = now.getMinutes().toString().padStart(2, '0');
            const s = now.getSeconds().toString().padStart(2, '0');

            dom.timeHour.textContent = h;
            dom.timeMin.textContent = m;
            dom.timeSec.textContent = s;
        }

        function startClock() {
            updateClock();
            state.clockIntervalId = setInterval(updateClock, 1000);
            dom.timeHour.classList.remove('hidden-force');
            dom.timeSepHour.classList.remove('hidden-force');
            dom.display.classList.add('clock-mode-text'); // Add Smaller Font Class

            // Hide Timer Controls
            dom.setupControls.classList.add('hidden-force');
            dom.mainActionBtn.classList.add('hidden-force'); // Hide Main Button ONLY
            dom.resetBtn.classList.add('hidden-force');
            dom.finishedControls.classList.add('hidden-force');
            // Note: We keep the parent container and aesthetic controls visible

            dom.btnModeToggle.innerHTML = `
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M5 12h14M12 5l7 7-7 7"/>
                </svg>
                切換倒數
            `;

            requestWakeLock(); // Keep screen on in clock mode
        }

        function stopClock() {
            clearInterval(state.clockIntervalId);
            dom.timeHour.classList.add('hidden-force');
            dom.timeSepHour.classList.add('hidden-force');
            dom.display.classList.remove('clock-mode-text'); // Remove Smaller Font Class

            // Restore Timer Controls (Visibility handled by updateControlsUI)
            dom.mainActionBtn.classList.remove('hidden-force');
            dom.resetBtn.classList.remove('hidden-force');
            dom.resetBtn.classList.remove('hidden-force');

            dom.btnModeToggle.innerHTML = `
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="12" cy="12" r="10"></circle>
                    <polyline points="12 6 12 12 16 14"></polyline>
                </svg>
                切換時鐘
            `;
            releaseWakeLock();
        }

        function toggleMode() {
            audioEngine.playBeep();
            if (state.displayMode === 'timer') {
                // Switch to Clock
                if (state.status === 'RUNNING') pauseTimer(); // Pause timer if running
                state.displayMode = 'clock';
                startClock();
            } else {
                // Switch to Timer
                state.displayMode = 'timer';
                stopClock();
                updateDisplay(); // Restore timer display
                updateControlsUI(); // Restore controls
            }
        }

        function toggleControls() {
            if (state.status === 'FINISHED') {
                showControls();
                return;
            }
            state.isControlsVisible ? hideControls() : showControls();
        }

        function hideControls() {
            state.isControlsVisible = false;
            dom.controlsPanel.classList.add('controls-hidden');
            // 移除原本的 translateY(10vh)，確保在全螢幕時絕對置中
            dom.container.style.transform = 'scale(1.1)';
        }

        function showControls() {
            state.isControlsVisible = true;
            dom.controlsPanel.classList.remove('controls-hidden');
            // 恢復原始比例，同樣保持置中
            dom.container.style.transform = 'scale(1)';
        }

        function bindEvents() {
            document.body.addEventListener('click', (e) => {
                if (dom.modal.contains(e.target) && !dom.modal.classList.contains('hidden-force')) return;
                toggleControls();
            });

            dom.controlsPanel.addEventListener('click', (e) => e.stopPropagation());

            dom.mainActionBtn.addEventListener('click', (e) => {
                e.stopPropagation();

                // 請求全螢幕 (必須在使用者點擊事件中觸發)
                if (!document.fullscreenElement) {
                    document.documentElement.requestFullscreen().catch(err => {
                        console.log("Fullscreen request failed", err);
                    });
                }

                if (state.status === 'RUNNING') {
                    pauseTimer();
                } else {
                    startTimer();
                }
            });

            dom.resetBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                audioEngine.playBeep();
                resetTimer();
            });

            // 快速加時間 (支援秒數)
            document.querySelectorAll('.quick-add').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    audioEngine.playBeep();
                    const secondsToAdd = parseInt(btn.dataset.add);
                    state.totalSeconds += secondsToAdd;
                    state.remainingSeconds = state.totalSeconds;
                    updateDisplay();
                });
            });

            // +/- 按鈕
            const adjustTime = (deltaSec) => {
                let newTime = state.totalSeconds + deltaSec;
                if (newTime < 0) newTime = 0;
                if (newTime > 5999) newTime = 5999;
                state.totalSeconds = newTime;
                state.remainingSeconds = state.totalSeconds;
                updateDisplay();
            };

            ['btn-plus', 'btn-minus'].forEach(id => {
                const btn = document.getElementById(id);
                let pressTimer;
                const delta = id === 'btn-plus' ? 10 : -10;

                btn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    audioEngine.playBeep();
                    adjustTime(delta);
                });
                btn.addEventListener('mousedown', (e) => {
                    e.stopPropagation();
                    pressTimer = setInterval(() => adjustTime(delta), 100);
                });
                btn.addEventListener('mouseup', () => clearInterval(pressTimer));
                btn.addEventListener('mouseleave', () => clearInterval(pressTimer));
                btn.addEventListener('touchstart', (e) => {
                    e.stopPropagation();
                    pressTimer = setInterval(() => adjustTime(delta), 100);
                }, { passive: false });
                btn.addEventListener('touchend', (e) => {
                    e.preventDefault();
                    clearInterval(pressTimer);
                });
            });

            dom.btnRestart.addEventListener('click', (e) => {
                e.stopPropagation();
                state.status = 'IDLE';
                state.remainingSeconds = state.totalSeconds;
                updateControlsUI();
                startTimer();
            });

            dom.btnBack.addEventListener('click', (e) => {
                e.stopPropagation();
                resetTimer();
            });

            // 音效切換
            dom.btnSoundDefault.addEventListener('click', (e) => {
                e.stopPropagation();
                state.audioMode = 'default';
                audioEngine.playBeep();
                updateControlsUI();
                localStorage.setItem('tablet_timer_audio_mode', 'default');
            });

            dom.btnSoundThinking.addEventListener('click', (e) => {
                e.stopPropagation();
                state.audioMode = 'thinking';
                audioEngine.playBeep();
                updateControlsUI();
                localStorage.setItem('tablet_timer_audio_mode', 'thinking');
            });

            dom.btnSoundEntertainment.addEventListener('click', (e) => {
                e.stopPropagation();
                state.audioMode = 'entertainment';
                audioEngine.playBeep();
                updateControlsUI();
                localStorage.setItem('tablet_timer_audio_mode', 'entertainment');
            });

            dom.btnSoundCustom.addEventListener('click', (e) => {
                e.stopPropagation();
                dom.audioUpload.click();
            });

            dom.audioUpload.addEventListener('change', async (e) => {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = async (ev) => {
                        await audioEngine.init();
                        audioEngine.ctx.decodeAudioData(ev.target.result, (buffer) => {
                            state.customBuffer = buffer;
                            state.audioMode = 'custom';
                            updateControlsUI();
                            localStorage.setItem('tablet_timer_audio_mode', 'custom');
                            audioEngine.playBeep(); // 成功載入提示
                        });
                    };
                    reader.readAsArrayBuffer(file);
                }
            });

            // 字型切換
            document.querySelectorAll('.font-switch').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    state.fontMode = btn.dataset.font;
                    audioEngine.playBeep();
                    updateControlsUI();
                    localStorage.setItem('tablet_timer_font_mode', state.fontMode);
                });
            });

            dom.btnModeToggle.addEventListener('click', (e) => {
                e.stopPropagation();
                toggleMode();
            });

            dom.display.addEventListener('click', (e) => {
                // Clock Mode: Toggle controls
                if (state.displayMode === 'clock') {
                    return; // Let bubbling handle toggleControls
                }

                // Timer Mode: 如果是運行中或暫停中，點擊時間數字應該是切換控制面板，而不是打開設定
                if (state.status !== 'IDLE') {
                    // 不 call stopPropagation，讓事件冒泡到 body 觸發 toggleControls
                    return;
                }

                e.stopPropagation();
                const min = Math.floor(state.totalSeconds / 60);
                const sec = state.totalSeconds % 60;
                dom.inputMin.value = min.toString().padStart(2, '0');
                dom.inputSec.value = sec.toString().padStart(2, '0');

                dom.modal.classList.remove('hidden-force');
                dom.inputMin.focus();
                dom.inputMin.select();
            });

            document.getElementById('btn-modal-cancel').addEventListener('click', (e) => {
                e.stopPropagation();
                dom.modal.classList.add('hidden-force');
            });

            document.getElementById('btn-modal-confirm').addEventListener('click', (e) => {
                e.stopPropagation();
                let m = parseInt(dom.inputMin.value) || 0;
                let s = parseInt(dom.inputSec.value) || 0;

                // 限制
                if (m < 0) m = 0;
                if (s < 0) s = 0;
                if (s > 59) s = 59; // 通常輸入秒數不超過 59

                const newTotal = m * 60 + s;
                if (newTotal > 0) {
                    state.totalSeconds = newTotal;
                    state.remainingSeconds = state.totalSeconds;
                    updateDisplay();
                }
                dom.modal.classList.add('hidden-force');
            });

            // 自動跳轉 Input
            dom.inputMin.addEventListener('input', (e) => {
                if (dom.inputMin.value.length >= 2) {
                    dom.inputSec.focus();
                    dom.inputSec.select();
                }
            });

            const savedTime = localStorage.getItem('tablet_timer_seconds');
            if (savedTime) {
                state.totalSeconds = parseInt(savedTime);
                state.remainingSeconds = state.totalSeconds;
            }

            const savedAudioMode = localStorage.getItem('tablet_timer_audio_mode');
            if (savedAudioMode) {
                state.audioMode = savedAudioMode;
            }

            const savedFontMode = localStorage.getItem('tablet_timer_font_mode');
            if (savedFontMode) {
                state.fontMode = savedFontMode;
            }

            updateControlsUI();
        }

        window.addEventListener('beforeunload', () => {
            localStorage.setItem('tablet_timer_seconds', state.totalSeconds);
        });

        function init() {
            updateDisplay();
            updateControlsUI();
            bindEvents();
            // 預先初始化音效引擎（生成空間殘響）
            audioEngine.init();
        }

        init();
    </script>
</body>

</html>