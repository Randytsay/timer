<!DOCTYPE html>
<html lang="zh-TW">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>å€’æ•¸è¨ˆæ™‚å™¨</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Arial Black', 'Microsoft JhengHei', sans-serif;
      transition: background-color 0.3s, color 0.3s;
      overflow-x: hidden;
      overflow-y: auto;
      user-select: none;
      min-height: 100vh;
    }

    body.dark {
      background: #000000;
      color: #ffffff;
    }

    body.light {
      background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
      color: #1a1a2e;
    }

    .container {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      min-height: 100vh;
      padding: 20px;
    }

    .controls-top {
      position: fixed;
      top: 20px;
      right: 20px;
      display: flex;
      gap: 15px;
      z-index: 1000;
      transition: opacity 0.3s;
    }

    .controls-top.hidden {
      opacity: 0;
      pointer-events: none;
    }

    .icon-btn {
      width: 60px;
      height: 60px;
      border-radius: 50%;
      border: none;
      font-size: 24px;
      cursor: pointer;
      transition: all 0.3s;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
    }

    .dark .icon-btn {
      background: #222222;
      color: #ffffff;
    }

    .light .icon-btn {
      background: #ffffff;
      color: #1a1a2e;
    }

    .icon-btn:hover {
      transform: scale(1.1);
    }

    .icon-btn:active {
      transform: scale(0.95);
    }

    /* é€²åº¦ç’°å®¹å™¨ */
    .timer-wrapper {
      position: relative;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .progress-ring {
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      pointer-events: none;
      z-index: 1000;
    }

    .progress-ring-bg {
      fill: none;
      stroke: rgba(255, 255, 255, 0.05);
    }

    .progress-ring-fill {
      fill: none;
      stroke: #2ecc71;
      stroke-linecap: square;
      transition: stroke-dashoffset 0.5s linear, stroke 0.3s ease;

      /* éœæ…‹æŸ”å’Œéœ“è™¹å…‰æšˆï¼Œä¸å†é–ƒçˆ */
      filter:
        drop-shadow(0 0 5px currentColor) drop-shadow(0 0 15px currentColor);
    }

    /* ç§»é™¤ neon-pulseå‹•ç•« */

    /* æ·ºè‰²æ¨¡å¼æŸ”å’Œç‰ˆ */
    .light .progress-ring-fill {
      filter: drop-shadow(0 0 3px currentColor);
    }

    .timer-display {
      font-size: 28vh;
      font-weight: 900;
      letter-spacing: 0.02em;
      line-height: 1;
      font-family: 'Impact', 'Arial Black', 'Microsoft JhengHei', sans-serif;
      transition: font-size 0.3s;
      cursor: pointer;
      z-index: 1;
    }

    .timer-display.running {
      font-size: 70vh;
      cursor: default;
    }

    .dark .timer-display {
      color: #ffffff;
      text-shadow: 0 0 40px rgba(255, 255, 255, 0.3);
    }

    .light .timer-display {
      color: #e74c3c;
      text-shadow: 0 0 20px rgba(231, 76, 60, 0.3);
    }

    .timer-display.finished {
      font-size: 45vh;
      /* ç§»é™¤é–ƒçˆå‹•ç•«ï¼Œæ”¹ç‚ºéœæ…‹ç™¼å…‰ */
      text-shadow: 0 0 20px rgba(255, 255, 255, 0.5), 0 0 40px rgba(231, 76, 60, 0.5);
      white-space: nowrap;
    }

    /* ç§»é™¤ pulse-neon */

    @keyframes pulse {

      0%,
      100% {
        opacity: 1;
        transform: scale(1);
      }

      50% {
        opacity: 0.7;
        transform: scale(1.05);
      }
    }

    .setup-panel {
      display: flex;
      flex-direction: column;
      gap: 30px;
      margin-bottom: 40px;
      transition: opacity 0.3s;
    }

    .setup-panel.hidden {
      display: none;
    }

    .quick-buttons {
      display: flex;
      gap: 15px;
      justify-content: center;
      flex-wrap: wrap;
    }

    .quick-btn {
      padding: 20px 40px;
      font-size: 28px;
      font-weight: bold;
      border: none;
      border-radius: 15px;
      cursor: pointer;
      transition: all 0.3s;
      min-width: 120px;
    }

    .dark .quick-btn {
      background: #333333;
      color: #ffffff;
    }

    .light .quick-btn {
      background: #3498db;
      color: #ffffff;
    }

    .quick-btn:hover {
      transform: translateY(-3px);
      box-shadow: 0 8px 20px rgba(0, 0, 0, 0.3);
    }

    .time-adjuster {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 20px;
    }

    .time-unit {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 10px;
    }

    .time-unit-label {
      font-size: 16px;
      opacity: 0.6;
    }

    .adjust-btn {
      width: 70px;
      height: 70px;
      font-size: 42px;
      font-weight: bold;
      border: none;
      border-radius: 50%;
      cursor: pointer;
      transition: all 0.3s;
    }

    .dark .adjust-btn {
      background: #444444;
      color: #ffffff;
    }

    .light .adjust-btn {
      background: #e74c3c;
      color: #ffffff;
    }

    .adjust-btn:hover {
      transform: scale(1.1);
    }

    .adjust-btn:active {
      transform: scale(0.9);
    }

    .time-input {
      font-size: 56px;
      font-weight: 900;
      text-align: center;
      min-width: 80px;
    }

    .dark .time-input {
      color: #ffffff;
    }

    .light .time-input {
      color: #e74c3c;
    }

    .time-separator {
      font-size: 56px;
      font-weight: 900;
      opacity: 0.5;
    }

    .main-buttons {
      display: flex;
      gap: 30px;
      flex-wrap: wrap;
      justify-content: center;
      transition: opacity 0.3s;
    }

    .main-buttons.hidden {
      display: none;
    }

    .main-btn {
      padding: 30px 60px;
      font-size: 36px;
      font-weight: bold;
      border: none;
      border-radius: 20px;
      cursor: pointer;
      transition: all 0.3s;
      min-width: 200px;
      box-shadow: 0 6px 20px rgba(0, 0, 0, 0.3);
    }

    .start-btn {
      background: #2ecc71;
      color: #ffffff;
    }

    .pause-btn {
      background: #f39c12;
      color: #ffffff;
    }

    .reset-btn {
      background: #e74c3c;
      color: #ffffff;
    }

    .main-btn:hover {
      transform: translateY(-5px);
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.4);
    }

    .main-btn:active {
      transform: translateY(-2px);
    }

    .main-btn.hidden {
      display: none;
    }

    .label {
      font-size: 24px;
      opacity: 0.8;
      margin-bottom: 10px;
    }

    /* éŸ³æ¨‚è¨­å®šå€ */
    .music-section {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 15px;
    }

    .music-options {
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
      justify-content: center;
    }

    .music-option {
      padding: 12px 20px;
      font-size: 18px;
      font-weight: bold;
      border: 3px solid transparent;
      border-radius: 12px;
      cursor: pointer;
      transition: all 0.3s;
    }

    .dark .music-option {
      background: #2a2a2a;
      color: #ffffff;
    }

    .light .music-option {
      background: #ecf0f1;
      color: #1a1a2e;
    }

    .music-option.active {
      border-color: #2ecc71;
      transform: scale(1.05);
    }

    .dark .music-option.active {
      background: #1a4d2e;
    }

    .light .music-option.active {
      background: #d5f4e6;
    }

    .music-option:hover {
      transform: translateY(-2px);
    }

    .upload-btn {
      padding: 12px 24px;
      font-size: 18px;
      font-weight: bold;
      border: none;
      border-radius: 12px;
      cursor: pointer;
      transition: all 0.3s;
    }

    .dark .upload-btn {
      background: #9b59b6;
      color: #ffffff;
    }

    .light .upload-btn {
      background: #8e44ad;
      color: #ffffff;
    }

    .upload-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 15px rgba(0, 0, 0, 0.3);
    }

    #audioFileInput {
      display: none;
    }

    .music-filename {
      font-size: 18px;
      opacity: 0.7;
      margin-top: 5px;
    }

    /* å½ˆå‡ºè¼¸å…¥æ¡† */
    .time-modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.8);
      z-index: 2000;
      align-items: center;
      justify-content: center;
    }

    .time-modal.show {
      display: flex;
    }

    .time-modal-content {
      background: #222;
      padding: 40px;
      border-radius: 20px;
      text-align: center;
    }

    .light .time-modal-content {
      background: #fff;
    }

    .time-modal-content input {
      font-size: 48px;
      width: 120px;
      text-align: center;
      border: 2px solid #2ecc71;
      border-radius: 10px;
      padding: 10px;
      margin: 0 10px;
      background: transparent;
      color: inherit;
    }

    .time-modal-content input:focus {
      outline: none;
      border-color: #27ae60;
    }

    .time-modal-buttons {
      margin-top: 30px;
      display: flex;
      gap: 20px;
      justify-content: center;
    }

    .time-modal-btn {
      padding: 15px 40px;
      font-size: 24px;
      border: none;
      border-radius: 10px;
      cursor: pointer;
      transition: all 0.3s;
    }

    .time-modal-btn.confirm {
      background: #2ecc71;
      color: #fff;
    }

    .time-modal-btn.cancel {
      background: #e74c3c;
      color: #fff;
    }

    /* é»æ“Šè¢å¹•é¡¯ç¤ºæ§åˆ¶ */
    .tap-hint {
      position: fixed;
      bottom: 30px;
      left: 50%;
      transform: translateX(-50%);
      font-size: 18px;
      opacity: 0.5;
      transition: opacity 0.3s;
    }

    .tap-hint.hidden {
      opacity: 0;
    }

    @media (max-width: 768px) {
      .timer-display {
        font-size: 20vh;
      }

      .timer-display.running {
        font-size: 28vh;
      }

      .main-btn {
        padding: 25px 50px;
        font-size: 28px;
      }

      .quick-btn {
        padding: 15px 30px;
        font-size: 24px;
      }

      .music-option,
      .upload-btn {
        font-size: 16px;
        padding: 10px 18px;
      }
    }

    @media (orientation: landscape) {
      .container {
        padding: 10px;
        gap: 10px;
      }

      .setup-panel {
        flex-direction: row;
        flex-wrap: wrap;
        justify-content: center;
        gap: 20px;
        margin-bottom: 15px;
      }

      .setup-panel>div {
        flex: 0 0 auto;
      }

      .label {
        font-size: 16px;
        margin-bottom: 5px;
      }

      .quick-buttons {
        gap: 8px;
      }

      .quick-btn {
        padding: 10px 20px;
        font-size: 18px;
        min-width: 80px;
      }

      .time-adjuster {
        gap: 10px;
      }

      .adjust-btn {
        width: 45px;
        height: 45px;
        font-size: 28px;
      }

      .time-input {
        font-size: 36px;
        min-width: 50px;
      }

      .time-separator {
        font-size: 36px;
      }

      .time-unit-label {
        font-size: 12px;
      }

      .music-options {
        gap: 6px;
      }

      .music-option {
        padding: 8px 12px;
        font-size: 14px;
      }

      .upload-btn {
        padding: 8px 16px;
        font-size: 14px;
      }

      /* æ©«å‘æ¨¡å¼ä¸‹é€²åº¦ç’°ä¾ç„¶ä¿æŒå…¨è¢å¹•å¤–æ¡† */
      .progress-ring {
        width: 100vw;
        height: 100vh;
      }

      .timer-wrapper {
        margin: 0;
      }

      .timer-display {
        font-size: 25vh;
      }

      .timer-display.running {
        font-size: 80vh;
      }

      .timer-display.finished {
        font-size: 60vh;
      }

      .main-buttons {
        gap: 15px;
      }

      .main-btn {
        padding: 15px 40px;
        font-size: 24px;
        min-width: 150px;
      }
    }
  </style>
</head>

<body class="dark">
  <div class="container">
    <div class="controls-top" id="controlsTop">
      <button class="icon-btn" id="themeBtn" title="åˆ‡æ›ä¸»é¡Œ">ğŸŒ“</button>
      <button class="icon-btn" id="fullscreenBtn" title="å…¨è¢å¹•">â›¶</button>
    </div>

    <div class="setup-panel" id="setupPanel">
      <div>
        <div class="label">å¿«é€Ÿè¨­å®š</div>
        <div class="quick-buttons">
          <button class="quick-btn" onclick="setTime(5, 0)">5 åˆ†</button>
          <button class="quick-btn" onclick="setTime(10, 0)">10 åˆ†</button>
          <button class="quick-btn" onclick="setTime(30, 0)">30 åˆ†</button>
          <button class="quick-btn" onclick="setTime(60, 0)">60 åˆ†</button>
        </div>
      </div>

      <div>
        <div class="label">è‡ªè¨‚æ™‚é–“</div>
        <div class="time-adjuster">
          <div class="time-unit">
            <button class="adjust-btn" id="minPlus" data-action="min-plus">+</button>
            <div class="time-input" id="minInput">30</div>
            <button class="adjust-btn" id="minMinus" data-action="min-minus">âˆ’</button>
            <div class="time-unit-label">åˆ†é˜</div>
          </div>
          <div class="time-separator">:</div>
          <div class="time-unit">
            <button class="adjust-btn" id="secPlus" data-action="sec-plus">+</button>
            <div class="time-input" id="secInput">00</div>
            <button class="adjust-btn" id="secMinus" data-action="sec-minus">âˆ’</button>
            <div class="time-unit-label">ç§’</div>
          </div>
        </div>
      </div>

      <div class="music-section">
        <div class="label">æé†’éŸ³æ•ˆï¼ˆé»æ“Šè©¦è½ï¼‰</div>
        <div class="music-options">
          <button class="music-option active" onclick="selectMusic('warm')" id="musicWarm">
            ğŸ¹ æº«æš–å’Œå¼¦
          </button>
          <button class="music-option" onclick="selectMusic('beep')" id="musicBeep">
            ğŸ“¢ å—¶å—¶è²
          </button>
          <button class="music-option" onclick="selectMusic('crystal')" id="musicCrystal">
            ğŸ’ æ°´æ™¶éˆ´éº
          </button>
          <button class="music-option" onclick="selectMusic('piano')" id="musicPiano">
            ğŸµ æŸ”å’Œé‹¼ç´
          </button>
          <button class="music-option" onclick="selectMusic('chimes')" id="musicChimes">
            ğŸ é¢¨éˆ´
          </button>
        </div>
        <button class="upload-btn" onclick="document.getElementById('audioFileInput').click()">
          ğŸ“ ä¸Šå‚³è‡ªè¨‚éŸ³æ¨‚
        </button>
        <input type="file" id="audioFileInput" accept="audio/*" onchange="handleAudioUpload(event)">
        <div class="music-filename" id="musicFilename"></div>
      </div>
    </div>

    <div class="timer-wrapper">
      <svg class="progress-ring" id="progressRing" viewBox="0 0 100 100" preserveAspectRatio="none">
        <rect class="progress-ring-bg" x="0.5" y="0.5" width="99" height="99" rx="3" ry="3" stroke-width="1" />
        <rect class="progress-ring-fill" id="progressFill" x="0.5" y="0.5" width="99" height="99" rx="3" ry="3"
          stroke-width="1" pathLength="100" />
      </svg>
      <div class="timer-display" id="timerDisplay" onclick="openTimeModal()">30:00</div>
    </div>

    <div class="main-buttons" id="mainButtons">
      <button class="main-btn start-btn" id="startBtn">é–‹å§‹</button>
      <button class="main-btn pause-btn hidden" id="pauseBtn">æš«åœ</button>
      <button class="main-btn reset-btn" id="resetBtn">é‡ç½®</button>
    </div>

    <div class="tap-hint hidden" id="tapHint">é»æ“Šè¢å¹•é¡¯ç¤ºæ§åˆ¶</div>
  </div>

  <!-- æ™‚é–“è¼¸å…¥å½ˆçª— -->
  <div class="time-modal" id="timeModal">
    <div class="time-modal-content">
      <div class="label">è¼¸å…¥æ™‚é–“</div>
      <input type="number" id="modalMinInput" min="0" max="999" value="30">
      <span class="time-separator">:</span>
      <input type="number" id="modalSecInput" min="0" max="59" value="00">
      <div class="time-modal-buttons">
        <button class="time-modal-btn confirm" onclick="confirmTimeInput()">ç¢ºå®š</button>
        <button class="time-modal-btn cancel" onclick="closeTimeModal()">å–æ¶ˆ</button>
      </div>
    </div>
  </div>

  <script>
    // ========== ç‹€æ…‹è®Šæ•¸ ==========
    let totalSeconds = 1800;
    let remainingSeconds = totalSeconds;
    let timerInterval = null;
    let isRunning = false;
    let audioContext = null;
    let controlsVisible = true;
    let selectedMusic = 'warm';
    let customAudio = null;
    let customAudioURL = null;
    let reverbBuffer = null;

    // é•·æŒ‰ç›¸é—œ
    let holdInterval = null;
    let holdTimeout = null;

    // ========== localStorage ==========
    function saveSettings() {
      const settings = {
        totalSeconds,
        selectedMusic,
        theme: document.body.classList.contains('dark') ? 'dark' : 'light'
      };
      localStorage.setItem('timerSettings', JSON.stringify(settings));
    }

    function loadSettings() {
      const saved = localStorage.getItem('timerSettings');
      if (saved) {
        const settings = JSON.parse(saved);
        totalSeconds = settings.totalSeconds || 1800;
        remainingSeconds = totalSeconds;
        selectedMusic = settings.selectedMusic || 'warm';

        // ä¸»é¡Œ
        if (settings.theme === 'light') {
          document.body.classList.remove('dark');
          document.body.classList.add('light');
        }

        // æ›´æ–°éŸ³æ•ˆæŒ‰éˆ•
        document.querySelectorAll('.music-option').forEach(btn => btn.classList.remove('active'));
        const musicBtn = document.getElementById('music' + selectedMusic.charAt(0).toUpperCase() + selectedMusic.slice(1));
        if (musicBtn) musicBtn.classList.add('active');

        updateInputDisplay();
        updateDisplay();
      }
    }

    // ========== é€²åº¦ç’° (çŸ©å½¢é‚Šæ¡†) ==========
    const progressFill = document.getElementById('progressFill');
    const circumference = 100; // ä½¿ç”¨ pathLength="100"
    progressFill.style.strokeDasharray = circumference;
    progressFill.style.strokeDashoffset = 0;

    function updateProgressRing() {
      const progress = remainingSeconds / totalSeconds;
      const offset = circumference * (1 - progress);
      progressFill.style.strokeDashoffset = offset;

      // é¡è‰²èˆ‡éœ“è™¹ç‡ˆå…‰æšˆåŒæ­¥è®ŠåŒ–
      let color = '#2ecc71';
      if (progress <= 0.2) color = '#e74c3c';
      else if (progress <= 0.5) color = '#f39c12';

      progressFill.style.stroke = color;
      progressFill.style.filter = `drop-shadow(0 0 8px ${color}) drop-shadow(0 0 15px ${color})`;
    }

    // ========== éŸ³è¨Šç³»çµ± ==========
    function initAudio() {
      if (!audioContext) {
        audioContext = new (window.AudioContext || window.webkitAudioContext)();
        createReverbBuffer();
      }
      if (audioContext.state === 'suspended') {
        audioContext.resume();
      }
    }

    // å‰µå»º reverb æ•ˆæœ
    async function createReverbBuffer() {
      const sampleRate = audioContext.sampleRate;
      const length = sampleRate * 2; // 2ç§’ reverb
      const buffer = audioContext.createBuffer(2, length, sampleRate);

      for (let channel = 0; channel < 2; channel++) {
        const data = buffer.getChannelData(channel);
        for (let i = 0; i < length; i++) {
          data[i] = (Math.random() * 2 - 1) * Math.pow(1 - i / length, 2);
        }
      }
      reverbBuffer = buffer;
    }

    function createReverb() {
      const convolver = audioContext.createConvolver();
      if (reverbBuffer) {
        convolver.buffer = reverbBuffer;
      }
      return convolver;
    }

    // æ’­æ”¾æº«æš–å’Œå¼¦ï¼ˆæ”¹é€²ç‰ˆï¼‰
    function playWarmChord() {
      initAudio();
      const now = audioContext.currentTime;
      const reverb = createReverb();
      const masterGain = audioContext.createGain();

      reverb.connect(masterGain);
      masterGain.connect(audioContext.destination);
      masterGain.gain.value = 0.6;

      // C major 7 å’Œå¼¦ï¼Œæ›´æº«æš–çš„éŸ³è‰²
      const frequencies = [261.63, 329.63, 392.00, 493.88]; // C4, E4, G4, B4

      frequencies.forEach((freq, index) => {
        const osc = audioContext.createOscillator();
        const gainNode = audioContext.createGain();
        const filter = audioContext.createBiquadFilter();

        filter.type = 'lowpass';
        filter.frequency.value = 2000;
        filter.Q.value = 1;

        osc.connect(filter);
        filter.connect(gainNode);
        gainNode.connect(reverb);
        gainNode.connect(audioContext.destination); // ä¹¾è²

        osc.frequency.value = freq;
        osc.type = 'sine';

        // ADSR envelope
        const attackTime = 0.1;
        const decayTime = 0.3;
        const sustainLevel = 0.4;
        const releaseTime = 1.5;

        gainNode.gain.setValueAtTime(0, now);
        gainNode.gain.linearRampToValueAtTime(0.25, now + attackTime);
        gainNode.gain.linearRampToValueAtTime(sustainLevel * 0.25, now + attackTime + decayTime);
        gainNode.gain.exponentialRampToValueAtTime(0.001, now + attackTime + decayTime + releaseTime);

        osc.start(now);
        osc.stop(now + 2);
      });
    }

    // æ’­æ”¾å—¶å—¶è²ï¼ˆæŸ”å’Œç‰ˆï¼‰
    function playBeepSound() {
      initAudio();
      const now = audioContext.currentTime;

      for (let i = 0; i < 3; i++) {
        const startTime = now + (i * 0.4);
        const osc = audioContext.createOscillator();
        const gainNode = audioContext.createGain();
        const filter = audioContext.createBiquadFilter();

        filter.type = 'lowpass';
        filter.frequency.value = 1500;

        osc.connect(filter);
        filter.connect(gainNode);
        gainNode.connect(audioContext.destination);

        osc.frequency.value = 660;
        osc.type = 'sine';

        gainNode.gain.setValueAtTime(0, startTime);
        gainNode.gain.linearRampToValueAtTime(0.3, startTime + 0.02);
        gainNode.gain.exponentialRampToValueAtTime(0.001, startTime + 0.25);

        osc.start(startTime);
        osc.stop(startTime + 0.25);
      }
    }

    // æ’­æ”¾æ°´æ™¶éˆ´éº
    function playCrystalBell() {
      initAudio();
      const now = audioContext.currentTime;
      const reverb = createReverb();
      const masterGain = audioContext.createGain();

      reverb.connect(masterGain);
      masterGain.connect(audioContext.destination);
      masterGain.gain.value = 0.5;

      // é«˜é »æ³›éŸ³çµ„åˆ
      const frequencies = [1396.91, 1760, 2093.00, 2637.02, 3135.96]; // F6, A6, C7, E7, G7

      frequencies.forEach((freq, index) => {
        const osc = audioContext.createOscillator();
        const gainNode = audioContext.createGain();

        osc.connect(gainNode);
        gainNode.connect(reverb);
        gainNode.connect(audioContext.destination);

        osc.frequency.value = freq;
        osc.type = 'sine';

        const volume = 0.15 / (index + 1);
        const delay = index * 0.05;

        gainNode.gain.setValueAtTime(0, now + delay);
        gainNode.gain.linearRampToValueAtTime(volume, now + delay + 0.01);
        gainNode.gain.exponentialRampToValueAtTime(0.001, now + delay + 1.5);

        osc.start(now + delay);
        osc.stop(now + delay + 1.5);
      });
    }

    // æ’­æ”¾æŸ”å’Œé‹¼ç´
    function playPianoSound() {
      initAudio();
      const now = audioContext.currentTime;
      const reverb = createReverb();
      const masterGain = audioContext.createGain();

      reverb.connect(masterGain);
      masterGain.connect(audioContext.destination);
      masterGain.gain.value = 0.4;

      // æ¨¡æ“¬é‹¼ç´éŸ³è‰² - ä½¿ç”¨å¤šå€‹æ­£å¼¦æ³¢ç–ŠåŠ 
      const notes = [523.25, 659.25, 783.99]; // C5, E5, G5

      notes.forEach((baseFreq, noteIndex) => {
        const startTime = now + noteIndex * 0.15;

        // åŸºé » + æ³›éŸ³
        [1, 2, 3, 4].forEach((harmonic, hIndex) => {
          const osc = audioContext.createOscillator();
          const gainNode = audioContext.createGain();

          osc.connect(gainNode);
          gainNode.connect(reverb);
          gainNode.connect(audioContext.destination);

          osc.frequency.value = baseFreq * harmonic;
          osc.type = 'sine';

          const volume = 0.2 / Math.pow(harmonic, 1.5);

          // é‹¼ç´ç‰¹æœ‰çš„å¿«é€Ÿè¡°æ¸›
          gainNode.gain.setValueAtTime(0, startTime);
          gainNode.gain.linearRampToValueAtTime(volume, startTime + 0.005);
          gainNode.gain.exponentialRampToValueAtTime(volume * 0.3, startTime + 0.1);
          gainNode.gain.exponentialRampToValueAtTime(0.001, startTime + 2);

          osc.start(startTime);
          osc.stop(startTime + 2);
        });
      });
    }

    // æ’­æ”¾é¢¨éˆ´
    function playChimesSound() {
      initAudio();
      const now = audioContext.currentTime;
      const reverb = createReverb();
      const masterGain = audioContext.createGain();

      reverb.connect(masterGain);
      masterGain.connect(audioContext.destination);
      masterGain.gain.value = 0.5;

      // äº”è²éŸ³éšé¢¨éˆ´
      const pentatonic = [523.25, 587.33, 659.25, 783.99, 880.00, 1046.50]; // C5 D5 E5 G5 A5 C6

      for (let i = 0; i < 6; i++) {
        const randomFreq = pentatonic[Math.floor(Math.random() * pentatonic.length)];
        const startTime = now + (i * 0.2) + (Math.random() * 0.1);

        const osc = audioContext.createOscillator();
        const gainNode = audioContext.createGain();

        osc.connect(gainNode);
        gainNode.connect(reverb);
        gainNode.connect(audioContext.destination);

        osc.frequency.value = randomFreq * (1 + Math.random() * 0.02); // å¾®å¾®èµ°éŸ³æ›´è‡ªç„¶
        osc.type = 'sine';

        gainNode.gain.setValueAtTime(0, startTime);
        gainNode.gain.linearRampToValueAtTime(0.15, startTime + 0.01);
        gainNode.gain.exponentialRampToValueAtTime(0.001, startTime + 1);

        osc.start(startTime);
        osc.stop(startTime + 1);
      }
    }

    // æ’­æ”¾è‡ªè¨‚éŸ³æ¨‚
    function playCustomSound() {
      if (customAudio) {
        customAudio.currentTime = 0;
        customAudio.play().catch(err => {
          console.error('æ’­æ”¾éŸ³æ¨‚å¤±æ•—:', err);
          playWarmChord();
        });
      }
    }

    // é¸æ“‡éŸ³æ¨‚ä¸¦è©¦è½
    function selectMusic(type) {
      selectedMusic = type;

      document.querySelectorAll('.music-option').forEach(btn => {
        btn.classList.remove('active');
      });

      const btnMap = {
        'warm': 'musicWarm',
        'beep': 'musicBeep',
        'crystal': 'musicCrystal',
        'piano': 'musicPiano',
        'chimes': 'musicChimes'
      };

      if (btnMap[type]) {
        document.getElementById(btnMap[type]).classList.add('active');
      }

      if (type !== 'custom') {
        document.getElementById('musicFilename').textContent = '';
      }

      // è©¦è½
      playAlertSound();
      saveSettings();
    }

    function handleAudioUpload(event) {
      const file = event.target.files[0];
      if (!file) return;

      if (customAudioURL) {
        URL.revokeObjectURL(customAudioURL);
      }

      customAudioURL = URL.createObjectURL(file);
      customAudio = new Audio(customAudioURL);

      selectedMusic = 'custom';
      document.querySelectorAll('.music-option').forEach(btn => {
        btn.classList.remove('active');
      });
      document.getElementById('musicFilename').textContent = `âœ“ ${file.name}`;

      // è©¦è½
      customAudio.play();
    }

    function playAlertSound() {
      switch (selectedMusic) {
        case 'warm': playWarmChord(); break;
        case 'beep': playBeepSound(); break;
        case 'crystal': playCrystalBell(); break;
        case 'piano': playPianoSound(); break;
        case 'chimes': playChimesSound(); break;
        case 'custom': playCustomSound(); break;
        default: playWarmChord();
      }
    }

    // ========== æ™‚é–“è¨­å®š ==========
    function setTime(minutes, seconds = 0) {
      if (isRunning) return;
      totalSeconds = minutes * 60 + seconds;
      remainingSeconds = totalSeconds;
      updateInputDisplay();
      updateDisplay();
      updateProgressRing();
      saveSettings();
    }

    function updateInputDisplay() {
      const minutes = Math.floor(totalSeconds / 60);
      const seconds = totalSeconds % 60;
      document.getElementById('minInput').textContent = String(minutes).padStart(2, '0');
      document.getElementById('secInput').textContent = String(seconds).padStart(2, '0');
    }

    function adjustTime(action) {
      if (isRunning) return;

      let minutes = Math.floor(totalSeconds / 60);
      let seconds = totalSeconds % 60;

      switch (action) {
        case 'min-plus': minutes = Math.min(999, minutes + 1); break;
        case 'min-minus': minutes = Math.max(0, minutes - 1); break;
        case 'sec-plus':
          seconds += 5;
          if (seconds >= 60) { seconds = 0; minutes++; }
          break;
        case 'sec-minus':
          seconds -= 5;
          if (seconds < 0) { seconds = 55; minutes = Math.max(0, minutes - 1); }
          break;
      }

      if (minutes === 0 && seconds === 0) seconds = 5; // è‡³å°‘5ç§’
      setTime(minutes, seconds);
    }

    // é•·æŒ‰æ”¯æ´
    function setupHoldButtons() {
      const buttons = document.querySelectorAll('.adjust-btn');

      buttons.forEach(btn => {
        const action = btn.dataset.action;

        const startHold = () => {
          adjustTime(action);
          holdTimeout = setTimeout(() => {
            holdInterval = setInterval(() => adjustTime(action), 100);
          }, 400);
        };

        const stopHold = () => {
          clearTimeout(holdTimeout);
          clearInterval(holdInterval);
        };

        btn.addEventListener('mousedown', startHold);
        btn.addEventListener('mouseup', stopHold);
        btn.addEventListener('mouseleave', stopHold);
        btn.addEventListener('touchstart', (e) => { e.preventDefault(); startHold(); });
        btn.addEventListener('touchend', stopHold);
      });
    }

    // ========== æ™‚é–“è¼¸å…¥å½ˆçª— ==========
    function openTimeModal() {
      if (isRunning) return;

      const display = document.getElementById('timerDisplay');
      if (display.classList.contains('finished')) return; // çµæŸç‹€æ…‹ä¸å…è¨±æ‰“é–‹

      const modal = document.getElementById('timeModal');
      const minutes = Math.floor(totalSeconds / 60);
      const seconds = totalSeconds % 60;
      document.getElementById('modalMinInput').value = minutes;
      document.getElementById('modalSecInput').value = seconds;
      modal.classList.add('show');
      document.getElementById('modalMinInput').focus();
    }

    function closeTimeModal() {
      document.getElementById('timeModal').classList.remove('show');
    }

    function confirmTimeInput() {
      const minutes = parseInt(document.getElementById('modalMinInput').value) || 0;
      const seconds = Math.min(59, parseInt(document.getElementById('modalSecInput').value) || 0);
      setTime(minutes, seconds);
      closeTimeModal();
    }

    // ========== è¨ˆæ™‚å™¨æ§åˆ¶ ==========
    function updateDisplay() {
      const minutes = Math.floor(remainingSeconds / 60);
      const seconds = remainingSeconds % 60;
      const display = `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
      document.getElementById('timerDisplay').textContent = display;
    }

    // ========== é‚è¼¯æ§åˆ¶ ==========

    function handleStartClick() {
      const display = document.getElementById('timerDisplay');

      // ç‹€æ…‹1: è¨ˆæ™‚å·²çµæŸ -> é‡æ–°é–‹å§‹
      if (display.classList.contains('finished')) {
        restartTimer();
        return;
      }

      // ç‹€æ…‹2: æš«åœä¸­/æœªé–‹å§‹ -> é–‹å§‹è¨ˆæ™‚
      if (!isRunning) {
        startTimer();
      }
    }

    function handleResetClick() {
      // ç„¡è«–ä»»ä½•ç‹€æ…‹ï¼ŒæŒ‰ä¸‹é‡ç½®éƒ½å›åˆ°åˆå§‹è¨­å®š
      resetTimer();
    }

    function startTimer() {
      if (isRunning) return;

      // é˜²æ­¢æ™‚é–“ç‚º 0 æˆ–è² æ•¸
      if (remainingSeconds <= 0) {
        remainingSeconds = totalSeconds > 0 ? totalSeconds : 300;
      }

      isRunning = true;

      // æŒ‰éˆ•ç‹€æ…‹ï¼šé¡¯ç¤ºæš«åœï¼Œéš±è—é–‹å§‹
      document.getElementById('startBtn').classList.add('hidden');
      document.getElementById('pauseBtn').classList.remove('hidden');

      // éš±è—è¨­å®šé¢æ¿å’Œå…¶ä»–æ§åˆ¶
      document.getElementById('setupPanel').classList.add('hidden');
      document.getElementById('controlsTop').classList.add('hidden');

      // é—œéµï¼šä¿æŒ mainButtons å¯è¦‹ï¼Œé€™æ¨£æš«åœæŒ‰éˆ•æ‰èƒ½è¢«é»æ“Šï¼
      document.getElementById('mainButtons').classList.remove('hidden');

      const display = document.getElementById('timerDisplay');
      display.classList.add('running');
      display.classList.remove('finished');
      document.getElementById('tapHint').classList.add('hidden'); // æ§åˆ¶åˆ—å·²ç¶“é¡¯ç¤ºï¼Œä¸éœ€è¦æç¤º

      updateDisplay();
      updateProgressRing();
      controlsVisible = true; // æ§åˆ¶åˆ—æ˜¯å¯è¦‹çš„

      // å•Ÿå‹•è¨ˆæ™‚
      if (timerInterval) clearInterval(timerInterval);
      timerInterval = setInterval(() => {
        remainingSeconds--;
        updateDisplay();
        updateProgressRing();

        if (remainingSeconds <= 0) {
          finishTimer();
        }
      }, 1000);
    }

    function pauseTimer() {
      isRunning = false;
      clearInterval(timerInterval);
      showControls();
    }

    function restartTimer() {
      isRunning = false;
      clearInterval(timerInterval);
      remainingSeconds = totalSeconds;

      document.getElementById('timerDisplay').classList.remove('finished');
      startTimer();
    }

    function resetTimer() {
      isRunning = false;
      clearInterval(timerInterval);
      remainingSeconds = totalSeconds;

      updateDisplay();
      updateProgressRing();

      document.getElementById('timerDisplay').classList.remove('running');
      document.getElementById('timerDisplay').classList.remove('finished');

      showControls();
    }

    function finishTimer() {
      clearInterval(timerInterval);
      isRunning = false;

      const display = document.getElementById('timerDisplay');
      display.textContent = 'æ™‚é–“åˆ°';
      display.classList.add('finished');
      display.classList.remove('running');

      showControls();

      // æ’­æ”¾éŸ³æ¨‚
      playAlertSound();
      if (selectedMusic !== 'custom') {
        setTimeout(() => playAlertSound(), 2000);
        setTimeout(() => playAlertSound(), 4000);
      }
    }

    function showControls() {
      controlsVisible = true;

      document.getElementById('mainButtons').classList.remove('hidden');
      document.getElementById('controlsTop').classList.remove('hidden');
      document.getElementById('setupPanel').classList.remove('hidden');
      document.getElementById('tapHint').classList.add('hidden');

      // æŒ‰éˆ•ç‹€æ…‹ç®¡ç†
      const startBtn = document.getElementById('startBtn');
      const resetBtn = document.getElementById('resetBtn');
      const pauseBtn = document.getElementById('pauseBtn');
      const display = document.getElementById('timerDisplay');

      pauseBtn.classList.add('hidden');
      startBtn.classList.remove('hidden');

      // åˆ¤æ–·æŒ‰éˆ•æ–‡å­—
      if (display.classList.contains('finished')) {
        startBtn.textContent = 'é‡æ–°é–‹å§‹';
        resetBtn.textContent = 'è¿”å›è¨­å®š';
      } else if (remainingSeconds < totalSeconds && remainingSeconds > 0) {
        startBtn.textContent = 'ç¹¼çºŒ';
        resetBtn.textContent = 'é‡ç½®';
      } else {
        startBtn.textContent = 'é–‹å§‹';
        resetBtn.textContent = 'é‡ç½®';
      }
    }

    function toggleControls() {
      const display = document.getElementById('timerDisplay');

      // å¦‚æœè¨ˆæ™‚å·²çµæŸï¼Œä¸å…è¨±éš±è—æ§åˆ¶ï¼ˆå¿…é ˆé¸æ“‡é‡æ–°é–‹å§‹æˆ–è¿”å›è¨­å®šï¼‰
      if (display.classList.contains('finished')) {
        return;
      }

      controlsVisible = !controlsVisible;

      const mainButtons = document.getElementById('mainButtons');
      const controlsTop = document.getElementById('controlsTop');
      const tapHint = document.getElementById('tapHint');
      const pauseBtn = document.getElementById('pauseBtn');
      const startBtn = document.getElementById('startBtn');

      if (controlsVisible) {
        // é¡¯ç¤ºæ§åˆ¶åˆ—
        mainButtons.classList.remove('hidden');
        controlsTop.classList.remove('hidden');
        tapHint.classList.add('hidden');

        if (isRunning) {
          pauseBtn.classList.remove('hidden');
          startBtn.classList.add('hidden');
        } else {
          pauseBtn.classList.add('hidden');
          startBtn.classList.remove('hidden');
        }
      } else {
        // éš±è—æ§åˆ¶åˆ—
        mainButtons.classList.add('hidden');
        controlsTop.classList.add('hidden');
        tapHint.classList.remove('hidden');
      }
    }

    // ========== äº‹ä»¶ç›£è½ ==========
    document.getElementById('themeBtn').addEventListener('click', () => {
      document.body.classList.toggle('dark');
      document.body.classList.toggle('light');
      saveSettings();
    });

    document.getElementById('fullscreenBtn').addEventListener('click', () => {
      if (!document.fullscreenElement) {
        document.documentElement.requestFullscreen();
      } else {
        document.exitFullscreen();
      }
    });

    document.addEventListener('click', (e) => {
      if (e.target.tagName === 'BUTTON' || e.target.tagName === 'INPUT') return;
      if (document.getElementById('timeModal').classList.contains('show')) return;
      toggleControls();
    });

    // Enter éµç¢ºèªè¼¸å…¥
    document.getElementById('modalMinInput').addEventListener('keydown', (e) => {
      if (e.key === 'Enter') confirmTimeInput();
      if (e.key === 'Escape') closeTimeModal();
    });
    document.getElementById('modalSecInput').addEventListener('keydown', (e) => {
      if (e.key === 'Enter') confirmTimeInput();
      if (e.key === 'Escape') closeTimeModal();
    });

    // ========== åˆå§‹åŒ– ==========
    loadSettings();
    updateDisplay();
    updateProgressRing();
    setupHoldButtons();

    // åˆå§‹åŒ–æŒ‰éˆ•ç›£è¯å™¨ï¼ˆä½¿ç”¨ stopPropagation é˜²æ­¢äº‹ä»¶å†’æ³¡ï¼‰
    document.getElementById('startBtn').addEventListener('click', function (e) {
      e.stopPropagation();
      handleStartClick();
    });

    document.getElementById('resetBtn').addEventListener('click', function (e) {
      e.stopPropagation();
      handleResetClick();
    });

    document.getElementById('pauseBtn').addEventListener('click', function (e) {
      e.stopPropagation();
      pauseTimer();
    });

    // ç¢ºä¿åˆå§‹ç‹€æ…‹æ­£ç¢º
    showControls();
  </script>
</body>

</html>